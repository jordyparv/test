WITH aggregatedNames AS (
    SELECT
        odsc.SWITCH_UNIVERSALID,
        listagg('{"fname":"' || odsc.fname || '","lname":"' || odsc.lname || '","cfd_role":"'|| odsc.CFD_ROLE || '","userid":"' || odsc.USERID || '"}' ,',') 
            WITHIN GROUP (ORDER BY odsc.fname, odsc.lname) AS tech_details
    FROM ops_data_switch_contacts odsc
    WHERE odsc.cfd_role = 'SWITCH_TECH'
    GROUP BY odsc.SWITCH_UNIVERSALID
),
filtered_sie AS (
    SELECT *
    FROM SWITCH_INSTALLED_ELEMENTS
    WHERE
        (:startDate IS NULL OR startDate = :startDate) AND
        (:endDate IS NULL OR endDate = :endDate)
),
paged_results AS (
    SELECT
        ods.SWITCH_UNID, 
        ods.sub_market AS market,
        ods.region AS sub_market,
        ag.tech_details,
        ods.address,
        ods.total_count,
        ods.NAME AS switch_name,
        ods.XING_ID AS CND_ID,
        ods.V_ZONE_NAME AS CALLOUT_ZONE,
        ods.SWITCH_NETWORK_ID AS FUZE_ID,
        ROW_NUMBER() OVER (ORDER BY ods.created_on DESC) AS rownum
    FROM aggregatedNames ag
    RIGHT JOIN ops_data_switch ods
        ON ag.SWITCH_UNIVERSALID = ods.switch_unid
    JOIN filtered_sie sie
        ON sie.location_id = ods.locationid
    WHERE
        (:name IS NULL OR LOWER(ods.NAME) = LOWER(:name)) AND
        (:switch_code IS NULL OR LOWER(ods.switch_code) = LOWER(:switch_code)) AND
        (:market IS NULL OR LOWER(ods.SUB_MARKET) = LOWER(:market)) AND
        (:vsm_name IS NULL OR LOWER(ods.vsm_switch) LIKE LOWER(:vsm_name))
)
SELECT *
FROM paged_results
WHERE rownum BETWEEN :startRow AND :endRow;
