with filterOPSE as (select distinct sie.location_id from switch_elements odse 
    join switch_installed_elements sie on sie.ELEMENT_ID = odse.ELEMENT_ID
      where ((:element_div is null or lower(odse.ELEMENT_DIVISION) like lower(:element_div)) AND
            (:element_dept is null or lower(odse.ELEMENT_DEPT) like lower(:element_dept)) AND
            (:element_sub_dept is null or lower(odse.ELEMENT_SUB_DEPT) like lower(:element_sub_dept))) AND
            (:startDate is null or :endDate is null or sie.start_date >= :startDate AND
              sie.end_date <= :endDate)),

        aggregatedNames as (
      select
      odsc.SWITCH_UNIVERSALID,
      listagg('{"fname":"' || odsc.fname || '","lname":"' || odsc.lname || '","cfd_role":"'|| odsc.CFD_ROLE || '","userid":"' || odsc.USERID || '"}' ,',') within group (order by odsc.fname,odsc.lname) as tech_details
      from ops_data_switch_contacts odsc
      INNER JOIN SEC_CONTACT sc on (odsc.userid = sc.login_id)
      where odsc.SWITCH_UNIVERSALID in (
        select odsc2.SWITCH_UNIVERSALID from ops_data_switch_contacts odsc2
        INNER JOIN SEC_CONTACT sc on (odsc2.userid = sc.login_id)
        where(
        (:techid is null or lower(odsc2.userid)=lower(:techid)) AND
        (:mgrid is null or lower(odsc2.userid)=lower(:mgrid)))) AND 
        odsc.cfd_role = 'SWITCH_TECH'
        
      GROUP BY odsc.SWITCH_UNIVERSALID)
        select distinct ods.SWITCH_UNID, ods.tech_details,ods.sub_market as market,ods.region as sub_market, ods.address, ods.total_count,ods.NAME as switch_name,ods.XING_ID AS CND_ID,ods.V_ZONE_NAME AS CALLOUT_ZONE,ods.SWITCH_NETWORK_ID AS FUZE_ID from
        (select ods.SWITCH_UNID,ag.tech_details, ODS.META_CREATEDDATE,odsc.*, ods.market,ods.sub_market,ods.region,ods.address,ods.NAME,ods.XING_ID,ods.V_ZONE_NAME,ods.SWITCH_NETWORK_ID, count(distinct ods.switch_unid) over() as total_count, rownum as rnum from ops_data_switch ods
        inner join ops_data_switch_contacts odsc
        on odsc.SWITCH_UNIVERSALID = ods.switch_unid
        join filterOPSE sie  on sie.location_id = ods.locationid
        inner join aggregatedNames ag on ag.SWITCH_UNIVERSALID = ods.switch_unid
        where
        (:name is null or lower(ods.NAME) like lower(:name)) AND
        (:area is null or lower(ods.MARKET)=lower(:area )) AND
        (:market is null or lower(ods.SUB_MARKET)=lower(:market)) AND
        (:sub_market is null or lower(ods.region)=lower(:sub_market)) AND
        (:vsm_name is null or lower(ods.vsm_switch) like lower(:vsm_name)) AND
        (:switch_code is null or lower(ods.switch_code) like lower(:switch_code))
        order by ods.META_CREATEDDATE desc
        ) ods
        where rnum between :startRow and :endRow
