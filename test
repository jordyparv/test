loadSwitchService.prototype.parseSwitchAttachment = function (data, callback) {
  if (!data || data.length === 0) {
    return callback(null, []); // Return an empty array if no data is available
  }

  console.log(data.length, "switch ops_attachments");

  // Helper function to process each item
  let attachmentPromises = data.map(async (item) => {
    let fileAttachment = {
      REFMETAID: item["source_universalid"],
      ATTACHMENT_NAME: item["file_name"],
      ATTACHMENT_SIZE: item["file_size"],
      ATTACHMENT_TYPE: item.file_name.split('.').pop(),
      META_UNIVERSALID: item["meta_universalID"],
      CREATED_ON: item["meta_createdDate"]
        ? moment(item["meta_createdDate"]).format("YYYY-MM-DD HH:mm:ss")
        : null,
      CREATED_BY: item["meta_createdBy"],
      MODIFIED_ON: item["meta_lastUpdateDate"]
        ? moment(item["meta_lastUpdateDate"]).format("YYYY-MM-DD HH:mm:ss")
        : null,
      MODIFIED_BY: item["meta_lastUpdateBy"],
      ATTACHMENT_CATEGORY: item["source_class"]?.replace(/c2/gi, ""),
      DESCRIPTION: item["description"],
      ATTACHMENT: null,
    };

    const url = `${config.opstracker.url}/C2Attachments/${item.source_universalid}/${encodeURIComponent(fileAttachment.ATTACHMENT_NAME)}`;

    try {
      const res = await http({
        url: url,
        method: "GET",
        responseType: "arraybuffer",
        headers: {
          Authorization: `${config.opstracker.authorization}`,
        },
      });

      if (res.data) {
        console.log(`File downloading: ${url}`);
        const file = btoa(String.fromCharCode(...new Uint8Array(res.data)));
        fileAttachment.ATTACHMENT = file;
        return { status: 'fulfilled', value: fileAttachment }; // Wrap in an object
      }
    } catch (error) {
      console.error(`Error downloading file: ${url}`, error.message);
      return { status: 'rejected', reason: error.message }; // Wrap in an object
    }
  });

  // Wait for all promises to resolve or reject
  Promise.allSettled(attachmentPromises)
    .then((results) => {
      console.log({ results });

      // Filter valid attachments
      const validAttachmentData = results
        .filter(result => result.status === 'fulfilled' && result.value !== null)
        .map(result => result.value); // Extract the fulfilled values

      if (validAttachmentData.length !== 0) {
        callback(null, validAttachmentData);
      } else {
        callback("Not valid file attachments");
      }

      // Log the reasons for any failures
      results.forEach((result, index) => {
        if (result.status === 'rejected') {
          console.error(`Error in attachment ${index + 1}:`, result.reason);
        }
      });
    })
    .catch(err => {
      console.error(err);
      callback("An unexpected error occurred while processing attachments.");
    });
};
