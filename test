WITH filterOPSE AS (
    SELECT DISTINCT sie.location_id
    FROM switch_elements odse
    JOIN switch_installed_elements sie ON sie.ELEMENT_ID = odse.ELEMENT_ID
    WHERE
        (:element_div IS NULL OR LOWER(odse.ELEMENT_DIVISION) LIKE LOWER(:element_div)) AND
        (:element_dept IS NULL OR LOWER(odse.ELEMENT_DEPT) LIKE LOWER(:element_dept)) AND
        (:element_sub_dept IS NULL OR LOWER(odse.ELEMENT_SUB_DEPT) LIKE LOWER(:element_sub_dept)) AND
        (:startDate IS NULL OR :endDate IS NULL OR (sie.start_date >= :startDate AND sie.end_date <= :endDate))
),

aggregatedNames AS (
    SELECT
        odsc.SWITCH_UNIVERSALID,
        LISTAGG('{"fname":"' || odsc.fname || '","lname":"' || odsc.lname || '","cfd_role":"' || odsc.CFD_ROLE || '","userid":"' || odsc.USERID || '"}', ',') 
            WITHIN GROUP (ORDER BY odsc.fname, odsc.lname) AS tech_details
    FROM ops_data_switch_contacts odsc
    INNER JOIN SEC_CONTACT sc ON odsc.userid = sc.login_id
    WHERE odsc.SWITCH_UNIVERSALID IN (
        SELECT odsc2.SWITCH_UNIVERSALID
        FROM ops_data_switch_contacts odsc2
        INNER JOIN SEC_CONTACT sc ON odsc2.userid = sc.login_id
        WHERE
            (:techid IS NULL OR LOWER(odsc2.userid) = LOWER(:techid)) AND
            (:mgrid IS NULL OR LOWER(odsc2.userid) = LOWER(:mgrid))
    ) AND odsc.cfd_role = 'SWITCH_TECH'
    GROUP BY odsc.SWITCH_UNIVERSALID
),

distinctSwitches AS (
    SELECT
        ods.SWITCH_UNID,
        ag.tech_details,
        ods.sub_market AS market,
        ods.region AS sub_market,
        ods.address,
        ods.NAME AS switch_name,
        ods.XING_ID AS CND_ID,
        ods.V_ZONE_NAME AS CALLOUT_ZONE,
        ods.SWITCH_NETWORK_ID AS FUZE_ID,
        COUNT(DISTINCT ods.SWITCH_UNID) OVER () AS total_count,
        ROW_NUMBER() OVER (ORDER BY ods.META_CREATEDDATE DESC) AS rnum
    FROM ops_data_switch ods
    INNER JOIN ops_data_switch_contacts odsc ON odsc.SWITCH_UNIVERSALID = ods.SWITCH_UNID
    JOIN filterOPSE sie ON sie.location_id = ods.locationid
    INNER JOIN aggregatedNames ag ON ag.SWITCH_UNIVERSALID = ods.SWITCH_UNID
    WHERE
        (:name IS NULL OR LOWER(ods.NAME) LIKE LOWER(:name)) AND
        (:area IS NULL OR LOWER(ods.MARKET) = LOWER(:area)) AND
        (:market IS NULL OR LOWER(ods.SUB_MARKET) = LOWER(:market)) AND
        (:sub_market IS NULL OR LOWER(ods.region) = LOWER(:sub_market)) AND
        (:vsm_name IS NULL OR LOWER(ods.vsm_switch) LIKE LOWER(:vsm_name)) AND
        (:switch_code IS NULL OR LOWER(ods.switch_code) LIKE LOWER(:switch_code))
)

SELECT DISTINCT
    SWITCH_UNID,
    tech_details,
    market,
    sub_market,
    address,
    switch_name,
    CND_ID,
    CALLOUT_ZONE,
    FUZE_ID,
    total_count
FROM distinctSwitches
WHERE rnum BETWEEN :startRow AND :endRow
ORDER BY rnum;  -- Ensure you have an ORDER BY clause for pagination
