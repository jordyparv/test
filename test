WITH aggregatedNames AS (
  SELECT
    odsc.SWITCH_UNIVERSALID,
    listagg('{"fname":"' || odsc.fname || '","lname":"' || odsc.lname || '","cfd_role":"'|| odsc.CFD_ROLE || '","userid":"' || odsc.USERID || '"}', ',') 
    WITHIN GROUP (ORDER BY odsc.fname, odsc.lname) AS tech_details
  FROM ops_data_switch_contacts odsc
  RIGHT JOIN SEC_CONTACT sc ON (odsc.userid = sc.login_id)
  WHERE odsc.cfd_role = 'SWITCH_TECH'
  GROUP BY odsc.SWITCH_UNIVERSALID
),
filterOPSE AS (
  SELECT DISTINCT sie.location_id
  FROM switch_elements odse
  JOIN switch_installed_elements sie ON sie.ELEMENT_ID = odse.ELEMENT_ID
  WHERE (
    (:element_div IS NULL OR LOWER(odse.ELEMENT_DIVISION) LIKE LOWER(:element_div)) AND
    (:element_dept IS NULL OR LOWER(odse.ELEMENT_DEPT) LIKE LOWER(:element_dept)) AND
    (:element_sub_dept IS NULL OR LOWER(odse.ELEMENT_SUB_DEPT) LIKE LOWER(:element_sub_dept))
  ) AND (
    :startDate IS NULL OR :endDate IS NULL OR sie.start_date >= :startDate AND sie.end_date <= :endDate
  )
)
SELECT * 
FROM (
  SELECT 
    rownum AS rnum, 
    ods2.* 
  FROM (
    SELECT 
      ods.name,
      ods.SWITCH_UNID, 
      ods.sub_market AS market,
      ods.region AS sub_market, 
      ods.tech_details, 
      ods.address, 
      ods.total_count,
      ods.NAME AS switch_name,
      ods.XING_ID AS CND_ID,
      ods.V_ZONE_NAME AS CALLOUT_ZONE,
      ods.SWITCH_EMIS_ID AS FUZE_ID
    FROM (
      SELECT DISTINCT
        ods.SWITCH_UNID,
        ODS.META_CREATEDDATE,
        ods.market,
        ods.sub_market,
        ods.region,
        ods.address || ', ' || ods.city || ' ' || ods.st || ' ' || ods.zip AS "ADDRESS",
        ods.city,
        ods.st,
        ods.zip,
        ods.NAME,
        ods.XING_ID,
        ods.V_ZONE_NAME,
        ods.SWITCH_EMIS_ID,
        ag.tech_details,
        COUNT(*) OVER() AS total_count
      FROM aggregatedNames ag
      RIGHT JOIN ops_data_switch ods ON ag.SWITCH_UNIVERSALID = ods.switch_unid
      JOIN filterOPSE sie ON sie.location_id = ods.locationid
      WHERE 
        (:area IS NULL OR LOWER(ods.market) = LOWER(:area)) AND
        (:name IS NULL OR LOWER(ods.NAME) LIKE LOWER(:name)) AND
        (:switch_code IS NULL OR LOWER(ods.switch_code) LIKE LOWER(:switch_code)) AND
        (:market IS NULL OR LOWER(ods.SUB_MARKET) = LOWER(:market)) AND
        (:sub_market IS NULL OR LOWER(ods.REGION) = LOWER(:sub_market)) AND
        (:vsm_name IS NULL OR LOWER(ods.vsm_switch) LIKE LOWER(:vsm_name))
    ) ods
    ORDER BY ods.name
  ) ods2
)
WHERE rnum BETWEEN :startRow AND :endRow;
